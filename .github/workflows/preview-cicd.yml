# feat/refactor etc -> developì— PR í•  ë•Œ ì‚¬ìš©ë˜ëŠ” ì›Œí¬í”Œë¡œì…ë‹ˆë‹¤.
# PR ì½”ë“œ ë¹Œë“œ & í…ŒìŠ¤íŠ¸ / Vercelì— preview ë°°í¬ / PR Commentì— preview URL + ì‹œê°„ì„ ë‚¨ê¹ë‹ˆë‹¤.
name: preview-cicd.yml

env:
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

on:
  pull_request:
    branches: [ develop ]

jobs:
  project-build:
    # ì‹¤í–‰ í™˜ê²½ìœ¼ë¡œ ubuntuì˜ ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest
    strategy:
      # Node.jsëŠ” 20 ë²„ì „ì„, pnpmì€ 10 ë²„ì „ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      matrix:
        node-version: [ 20 ]
    steps:
      # ì €ì¥ì†Œë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
      - name: Checkout
        uses: actions/checkout@v4

      # pnpmì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      # Node.js ì„¸íŒ… & pnpmì„ ìºì‹œí•©ë‹ˆë‹¤.
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      # pnpm installë¡œ ì˜ì¡´ì„± ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install dependencies
        run: pnpm install

      # pnpm run buildë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Build
        run: pnpm run build

      # pnpm testë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Test
        run: pnpm test:ci

  # project-buildê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤ë©´, ë‹¤ìŒ deploy-to-vercelì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
  deploy-to-vercel:
    runs-on: ubuntu-latest
    needs: project-build
    # ì¶œë ¥ê°’ìœ¼ë¡œ, preview_url(ì‚¬ì „ Vercel ë°°í¬ ë§í¬) & current_time(í˜„ì¬ ì‹œê°)ì„ ì¶œë ¥í•©ë‹ˆë‹¤.
    outputs:
      preview_url: ${{ steps.deploy-vercel.outputs.preview_url }}
      current_time: ${{ steps.current-time.outputs.formattedTime }}
    strategy:
      matrix:
        node-version: [ 20 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      # Github Action ì‹¤í–‰ í™˜ê²½ê³¼ vercel í”„ë¡œì íŠ¸ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
      - name: Link Vercel project (non-interactive)
        run: |
          pnpm dlx vercel@latest link --project uiux-server --yes --token=${{ secrets.VERCEL_TOKEN }}

      # Vercelì— ì €ì¥ëœ í™˜ê²½ ë³€ìˆ˜(VERCEL_TOKEN)ì„ í˜„ì¬ CI í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Pull env (preview)
        run: pnpm dlx vercel@latest pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      # Vercel CLIë¥¼ ì´ìš©í•´ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.
      - name: Build
        run: pnpm dlx vercel@latest build --token=${{ secrets.VERCEL_TOKEN }}

      # ì•ì—ì„œ ë¹Œë“œí•œ ê²°ê³¼ë¬¼ì„ ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ í›„, Preview í™˜ê²½ì— ë°°í¬í•©ë‹ˆë‹¤.
      # ì¶œë ¥ëœ Preview URLì€ vercel-output.txtì— ì €ì¥í•˜ê³ , í•´ë‹¹ URLì„ ë¶ˆëŸ¬ì™€ job outputì— ë“±ë¡í•©ë‹ˆë‹¤.
      - name: Deploy (prebuilt)
        id: deploy-vercel
        run: |
          pnpm dlx vercel@latest deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} > vercel-output.txt
          echo "preview_url=$(cat vercel-output.txt)" >> $GITHUB_OUTPUT

      # ë°°í¬ ì™„ë£Œ ì‹œê°ì„ ê°€ì ¸ì™€, PR ì½”ë©˜íŠ¸ì— í‘œì‹œí•˜ë„ë¡ í•©ë‹ˆë‹¤.
      - name: Get current Time
        uses: josStorer/get-current-time@v2
        id: current-time
        with:
          format: "YYYYë…„ MMì›” DDì¼ HHì‹œ mmë¶„"
          utcOffset: "+09:00"

  # PR ì½”ë©˜íŠ¸ì— preview URLê³¼ ë°°í¬ ì‹œê°ì„ ì½”ë©˜íŠ¸ë¡œ ë‹¬ì•„ì£¼ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
  preview-comment:
    runs-on: ubuntu-latest
    needs: [ deploy-to-vercel ]
    steps:
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: ${{ github.event.number }}
          message: |
            ğŸ§· Preview: ${{ needs.deploy-to-vercel.outputs.preview_url }}
            â° Update: ${{ needs.deploy-to-vercel.outputs.current_time }}